
require(testthat)
require(PortfolioAnalytics)

context("test CRRA objective")

data(edhec)

ret <-edhec[,1:4]

test_that("crra.moments satisfies testcase",{
  test_Moments <- crra.moments(ret)
  
  expect_equal( test_Moments$mu
              , c(`Convertible Arbitrage` = 0.00550036363636364, `CTA Global` = 0.00415818181818182, 
                  `Distressed Securities` = 0.00662181818181818, `Emerging Markets` = 0.00624581818181818)
              , tolerance = 1e-6)
  
  expect_equal( test_Moments$sigma
            , structure(c(0.00026559040132714, -7.69330590577306e-06, 0.000201032692767087, 
                          0.000311890348241539, -7.69330590577306e-06, 0.000535625726609157, 
                          -8.0756901128069e-06, 3.03012660915727e-05, 0.000201032692767087, 
                          -8.0756901128069e-06, 0.000285105069674851, 0.000422710091572661, 
                          0.000311890348241539, 3.03012660915727e-05, 0.000422710091572661, 
                          0.00103173278354346)
                        , .Dim = c(4L, 4L)
                        , .Dimnames = list( c("Convertible Arbitrage", "CTA Global", "Distressed Securities", "Emerging Markets")
                                          , c("Convertible Arbitrage", "CTA Global", "Distressed Securities", "Emerging Markets")))
                , tolerance = 1e-6)
  
  expect_equal( test_Moments$m3
              , structure(c(-1.14055206123106e-05, 1.71497630972778e-06, -7.62105729469836e-06, 
                              -1.29154052633796e-05, 1.71497630972778e-06, -1.47741511116454e-06, 
                              2.14583792309181e-06, 3.96520729658999e-06, -7.62105729469836e-06, 
                              2.14583792309181e-06, -5.73442373402735e-06, -9.71386582029775e-06, 
                              -1.29154052633796e-05, 3.96520729658999e-06, -9.71386582029775e-06, 
                              -1.61111739585129e-05, 1.71497630972778e-06, -1.47741511116454e-06, 
                              2.14583792309181e-06, 3.96520729658999e-06, -1.47741511116454e-06, 
                              1.96374762907889e-06, -1.94367002517806e-06, -3.05145975258302e-06, 
                              2.14583792309181e-06, -1.94367002517806e-06, 3.31049041486401e-06, 
                              6.94895013013014e-06, 3.96520729658999e-06, -3.05145975258302e-06, 
                              6.94895013013014e-06, 1.44081684900217e-05, -7.62105729469836e-06, 
                              2.14583792309181e-06, -5.73442373402735e-06, -9.71386582029775e-06, 
                              2.14583792309181e-06, -1.94367002517806e-06, 3.31049041486401e-06, 
                              6.94895013013014e-06, -5.73442373402735e-06, 3.31049041486401e-06, 
                              -5.97268436613674e-06, -1.08440328089004e-05, -9.71386582029775e-06, 
                              6.94895013013014e-06, -1.08440328089004e-05, -2.01624262962022e-05, 
                              -1.29154052633796e-05, 3.96520729658999e-06, -9.71386582029775e-06, 
                              -1.61111739585129e-05, 3.96520729658999e-06, -3.05145975258302e-06, 
                              6.94895013013014e-06, 1.44081684900217e-05, -9.71386582029775e-06, 
                              6.94895013013014e-06, -1.08440328089004e-05, -2.01624262962022e-05, 
                              -1.61111739585129e-05, 1.44081684900217e-05, -2.01624262962022e-05, 
                              -3.8336009386576e-05), .Dim = c(4L, 16L))  
                , tolerance = 1e-8)
  
  expect_equal( test_Moments$m4
              ,  structure(c(1.66516458485458e-06, -2.26496140091499e-07, 1.04369036193136e-06, 
                            1.76020235077966e-06, -2.26496140091499e-07, 1.47727066137582e-07, 
                            -1.6937217647752e-07, -2.90397064444282e-07, 1.04369036193136e-06, 
                            -1.6937217647752e-07, 7.10256484768356e-07, 1.20355734511567e-06, 
                            1.76020235077966e-06, -2.90397064444282e-07, 1.20355734511567e-06, 
                            2.10458943084486e-06, -2.26496140091499e-07, 1.47727066137582e-07, 
                            -1.6937217647752e-07, -2.90397064444282e-07, 1.47727066137582e-07, 
                            -3.12508208391881e-08, 1.45678105886612e-07, 2.55464213651398e-07, 
                            -1.6937217647752e-07, 1.45678105886612e-07, -1.60000644553622e-07, 
                            -3.01298165149802e-07, -2.90397064444282e-07, 2.55464213651398e-07, 
                            -3.01298165149802e-07, -5.79650222687517e-07, 1.04369036193136e-06, 
                            -1.6937217647752e-07, 7.10256484768356e-07, 1.20355734511567e-06, 
                            -1.6937217647752e-07, 1.45678105886612e-07, -1.60000644553622e-07, 
                            -3.01298165149802e-07, 7.10256484768356e-07, -1.60000644553622e-07, 
                            5.62051755190419e-07, 9.71742089994789e-07, 1.20355734511567e-06, 
                            -3.01298165149802e-07, 9.71742089994789e-07, 1.75026495387135e-06, 
                            1.76020235077966e-06, -2.90397064444282e-07, 1.20355734511567e-06, 
                            2.10458943084486e-06, -2.90397064444282e-07, 2.55464213651398e-07, 
                            -3.01298165149802e-07, -5.79650222687517e-07, 1.20355734511567e-06, 
                            -3.01298165149802e-07, 9.71742089994789e-07, 1.75026495387135e-06, 
                            2.10458943084486e-06, -5.79650222687517e-07, 1.75026495387135e-06, 
                            3.24853894214092e-06, -2.26496140091499e-07, 1.47727066137582e-07, 
                            -1.6937217647752e-07, -2.90397064444282e-07, 1.47727066137582e-07, 
                            -3.12508208391881e-08, 1.45678105886612e-07, 2.55464213651398e-07, 
                            -1.6937217647752e-07, 1.45678105886612e-07, -1.60000644553622e-07, 
                            -3.01298165149802e-07, -2.90397064444282e-07, 2.55464213651398e-07, 
                            -3.01298165149802e-07, -5.79650222687517e-07, 1.47727066137582e-07, 
                            -3.12508208391881e-08, 1.45678105886612e-07, 2.55464213651398e-07, 
                            -3.12508208391881e-08, 8.39519599260346e-07, -7.87100280242557e-08, 
                            -1.02790809458905e-07, 1.45678105886612e-07, -7.87100280242557e-08, 
                            2.51308433531603e-07, 4.52704609480637e-07, 2.55464213651398e-07, 
                            -1.02790809458905e-07, 4.52704609480637e-07, 1.06568587829695e-06, 
                            -1.6937217647752e-07, 1.45678105886612e-07, -1.60000644553622e-07, 
                            -3.01298165149802e-07, 1.45678105886612e-07, -7.87100280242557e-08, 
                            2.51308433531603e-07, 4.52704609480637e-07, -1.60000644553622e-07, 
                            2.51308433531603e-07, -2.27373876149356e-07, -4.6109685194065e-07, 
                            -3.01298165149802e-07, 4.52704609480637e-07, -4.6109685194065e-07, 
                            -9.45255398413001e-07, -2.90397064444282e-07, 2.55464213651398e-07, 
                            -3.01298165149802e-07, -5.79650222687517e-07, 2.55464213651398e-07, 
                            -1.02790809458905e-07, 4.52704609480637e-07, 1.06568587829695e-06, 
                            -3.01298165149802e-07, 4.52704609480637e-07, -4.6109685194065e-07, 
                            -9.45255398413001e-07, -5.79650222687517e-07, 1.06568587829695e-06, 
                            -9.45255398413001e-07, -1.92019886512898e-06, 1.04369036193136e-06, 
                            -1.6937217647752e-07, 7.10256484768356e-07, 1.20355734511567e-06, 
                            -1.6937217647752e-07, 1.45678105886612e-07, -1.60000644553622e-07, 
                            -3.01298165149802e-07, 7.10256484768356e-07, -1.60000644553622e-07, 
                            5.62051755190419e-07, 9.71742089994789e-07, 1.20355734511567e-06, 
                            -3.01298165149802e-07, 9.71742089994789e-07, 1.75026495387135e-06, 
                            -1.6937217647752e-07, 1.45678105886612e-07, -1.60000644553622e-07, 
                            -3.01298165149802e-07, 1.45678105886612e-07, -7.87100280242557e-08, 
                            2.51308433531603e-07, 4.52704609480637e-07, -1.60000644553622e-07, 
                            2.51308433531603e-07, -2.27373876149356e-07, -4.6109685194065e-07, 
                            -3.01298165149802e-07, 4.52704609480637e-07, -4.6109685194065e-07, 
                            -9.45255398413001e-07, 7.10256484768356e-07, -1.60000644553622e-07, 
                            5.62051755190419e-07, 9.71742089994789e-07, -1.60000644553622e-07, 
                            2.51308433531603e-07, -2.27373876149356e-07, -4.6109685194065e-07, 
                            5.62051755190419e-07, -2.27373876149356e-07, 6.27442496267522e-07, 
                            1.12144630379505e-06, 9.71742089994789e-07, -4.6109685194065e-07, 
                            1.12144630379505e-06, 2.16270685044171e-06, 1.20355734511567e-06, 
                            -3.01298165149802e-07, 9.71742089994789e-07, 1.75026495387135e-06, 
                            -3.01298165149802e-07, 4.52704609480637e-07, -4.6109685194065e-07, 
                            -9.45255398413001e-07, 9.71742089994789e-07, -4.6109685194065e-07, 
                            1.12144630379505e-06, 2.16270685044171e-06, 1.75026495387135e-06, 
                            -9.45255398413001e-07, 2.16270685044171e-06, 4.39568811454184e-06, 
                            1.76020235077966e-06, -2.90397064444282e-07, 1.20355734511567e-06, 
                            2.10458943084486e-06, -2.90397064444282e-07, 2.55464213651398e-07, 
                            -3.01298165149802e-07, -5.79650222687517e-07, 1.20355734511567e-06, 
                            -3.01298165149802e-07, 9.71742089994789e-07, 1.75026495387135e-06, 
                            2.10458943084486e-06, -5.79650222687517e-07, 1.75026495387135e-06, 
                            3.24853894214092e-06, -2.90397064444282e-07, 2.55464213651398e-07, 
                            -3.01298165149802e-07, -5.79650222687517e-07, 2.55464213651398e-07, 
                            -1.02790809458905e-07, 4.52704609480637e-07, 1.06568587829695e-06, 
                            -3.01298165149802e-07, 4.52704609480637e-07, -4.6109685194065e-07, 
                            -9.45255398413001e-07, -5.79650222687517e-07, 1.06568587829695e-06, 
                            -9.45255398413001e-07, -1.92019886512898e-06, 1.20355734511567e-06, 
                            -3.01298165149802e-07, 9.71742089994789e-07, 1.75026495387135e-06, 
                            -3.01298165149802e-07, 4.52704609480637e-07, -4.6109685194065e-07, 
                            -9.45255398413001e-07, 9.71742089994789e-07, -4.6109685194065e-07, 
                            1.12144630379505e-06, 2.16270685044171e-06, 1.75026495387135e-06, 
                            -9.45255398413001e-07, 2.16270685044171e-06, 4.39568811454184e-06, 
                            2.10458943084486e-06, -5.79650222687517e-07, 1.75026495387135e-06, 
                            3.24853894214092e-06, -5.79650222687517e-07, 1.06568587829695e-06, 
                            -9.45255398413001e-07, -1.92019886512898e-06, 1.75026495387135e-06, 
                            -9.45255398413001e-07, 2.16270685044171e-06, 4.39568811454184e-06, 
                            3.24853894214092e-06, -1.92019886512898e-06, 4.39568811454184e-06, 
                            9.86021269776405e-06), .Dim = c(4L, 64L))
                , tolerance = 1e-8)
  
  
  
  
})

test_that("crra objective function satisfies testcase",{

Moments <- crra.moments(ret)
Equalweights <- rep(1/ncol(ret), ncol(ret))
CRRA_test <- CRRA(R = ret, weights = Equalweights, lambda = 5, sigma = Moments$sigma, m3 = Moments$m3, m4 = Moments$m4)

CRRA_expected <- structure(-0.00064838062787029, .Dim = c(1L, 1L))

expect_equal(CRRA_test,CRRA_expected, tolerance = 1e-8)

})



test_that("crra crra.RobustMoments function satisfies testcase",{
  
  Moments2 <- crra.RobustMoments(R = ret, k = 3)
  Equalweights <- rep(1/ncol(ret), ncol(ret))
  CRRA_test <- CRRA(R = ret, weights = Equalweights, lambda = 5, sigma = Moments2$sigma, m3 = Moments2$m3, m4 = Moments2$m4)
  
  CRRA_expected <- structure(-0.00065818044236162, .Dim = c(1L, 1L))
  
  expect_equal(CRRA_test,CRRA_expected, tolerance = 1e-8)
  
})




